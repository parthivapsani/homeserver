# =============================================================================
# HOME AUTOMATION
# =============================================================================
# - Home Assistant: Smart home hub
# - Mosquitto: MQTT broker for IoT devices
# - Zigbee2MQTT: Zigbee device bridge (optional, requires coordinator)
# - OctoPrint: 3D printer management
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Home Assistant
  # ---------------------------------------------------------------------------
  # Access: http://server-ip:8123
  # Uses host network for device discovery (mDNS, SSDP)
  # ---------------------------------------------------------------------------
  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    hostname: homeassistant
    restart: unless-stopped
    # Host network required for device discovery
    network_mode: host
    environment:
      - TZ=${TZ}
    volumes:
      - ${APPDATA_PATH}/homeassistant:/config
      - /run/dbus:/run/dbus:ro
    # Uncomment if you have a Zigbee/Z-Wave USB stick
    # devices:
    #   - /dev/ttyUSB0:/dev/ttyUSB0
    #   - /dev/ttyACM0:/dev/ttyACM0
    privileged: true
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.homeassistant.rule=Host(`ha.${DOMAIN}`)"
      - "traefik.http.routers.homeassistant.entrypoints=websecure"
      - "traefik.http.routers.homeassistant.tls.certresolver=cloudflare"
      - "traefik.http.services.homeassistant.loadbalancer.server.port=8123"

  # ---------------------------------------------------------------------------
  # Mosquitto - MQTT Broker
  # ---------------------------------------------------------------------------
  # MQTT broker for Home Assistant, Zigbee2MQTT, and other IoT devices
  # Port 1883: MQTT
  # Port 9001: WebSocket
  # ---------------------------------------------------------------------------
  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: mosquitto
    hostname: mosquitto
    restart: unless-stopped
    networks:
      - homeserver
    ports:
      - "1883:1883"
      - "9001:9001"
    environment:
      - TZ=${TZ}
    volumes:
      - ${APPDATA_PATH}/mosquitto/config:/mosquitto/config
      - mosquitto_data:/mosquitto/data
      - mosquitto_logs:/mosquitto/log
    # Create mosquitto.conf before first run - see setup instructions

  # ---------------------------------------------------------------------------
  # Zigbee2MQTT (Optional)
  # ---------------------------------------------------------------------------
  # Requires a Zigbee coordinator (USB stick like Sonoff Zigbee 3.0)
  # Uncomment and configure if you have Zigbee devices
  # ---------------------------------------------------------------------------
  # zigbee2mqtt:
  #   image: koenkk/zigbee2mqtt:latest
  #   container_name: zigbee2mqtt
  #   hostname: zigbee2mqtt
  #   restart: unless-stopped
  #   networks:
  #     - homeserver
  #   ports:
  #     - "8082:8080"
  #   environment:
  #     - TZ=${TZ}
  #   volumes:
  #     - ${APPDATA_PATH}/zigbee2mqtt:/app/data
  #     - /run/udev:/run/udev:ro
  #   devices:
  #     - /dev/ttyUSB0:/dev/ttyUSB0  # Adjust to your Zigbee coordinator
  #   depends_on:
  #     - mosquitto

  # ---------------------------------------------------------------------------
  # OctoPrint - 3D Printer Management
  # ---------------------------------------------------------------------------
  # Access: http://server-ip:5000
  # Requires USB passthrough for printer connection
  # ---------------------------------------------------------------------------
  octoprint:
    image: octoprint/octoprint:latest
    container_name: octoprint
    hostname: octoprint
    restart: unless-stopped
    networks:
      - homeserver
    ports:
      - "${OCTOPRINT_PORT:-5000}:80"
    environment:
      - TZ=${TZ}
      - ENABLE_MJPG_STREAMER=true
    volumes:
      - ${APPDATA_PATH}/octoprint:/octoprint
    # USB devices - uncomment and adjust for your printer/webcam
    # devices:
    #   - /dev/ttyUSB0:/dev/ttyUSB0      # 3D Printer
    #   - /dev/ttyACM0:/dev/ttyACM0      # Alternative printer port
    #   - /dev/video0:/dev/video0        # Webcam
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.octoprint.rule=Host(`octoprint.${DOMAIN}`)"
      - "traefik.http.routers.octoprint.entrypoints=websecure"
      - "traefik.http.routers.octoprint.tls.certresolver=cloudflare"
      - "traefik.http.services.octoprint.loadbalancer.server.port=80"
